\clearpage
\begin{savequote}[8cm]
\textlatin{Neque porro quisquam est qui dolorem ipsum quia dolor sit amet, consectetur, adipisci velit...}

There is no one who loves pain itself, who seeks after it and wants to have it, simply because it is pain...
  \qauthor{--- Cicero's \textit{de Finibus Bonorum et Malorum}}
\end{savequote}

\chapter{\label{ch:4-selection}Selection and mass fit of \decay{\Bpm}{\D\Kstarpm} decays} 

\minitoc

\section{Selection}
\label{sec:selection}

The selection requirements for \decay{\Bpm}{\D\Kstarpm} candidates are described here.

\subsection{Stripping and trigger}
\label{sec:selection:strippingandtrigger}

The data used in the analysis is summarised in Table \ref{data}. All data is processed using \davinci and \decay{\Bpm}{\D\Kstarpm} candiates, where the \Kstarm decays to \KS$\pim$, are taken from stripping.

\begin{table}[h]
\centering
\begin{tabular}{llllll}
\hline
Year & $\sqrt{s}$ / \tev & Integrated luminosity / \invfb & Reprocessing & Stripping & \davinci version \\
\hline
2011 & 7.0 & 1.0 & Reco14 & S21r1p1 & v39r1p1 \\
2012 & 8.0 & 2.0 & Reco14 & S21r0p1 & v39r1p1 \\
2015 & 13.0 & 0.3 & Reco15a & S24 & v38r1p1 \\
2016 & 13.0 & 1.5 & Reco16 & S26 & v40r3p1 \\
\hline
\end{tabular}
\caption{Summary of the data used in the analysis, where $\sqrt{s}$ represents the center of mass energy of the proton-proton collisions}
\label{data}
\end{table}

$B^{\pm} \to DK^{*\pm}$ candidates were selected using stripping lines in the {\tt BHADRON} stripping stream, {\tt B2D0KsPiLLD2HHBeauty2CharmLine} and {\tt B2D0KsPiDDD2HHBeauty2CharmLine}, producing two sets of candidates; one set of LL candidates and one set of DD candidates. The difference between these types of candidates is explained in Section \ref{sec:selection:pre-selection}. All B candidates are required to have passed the following triggers:
%
\begin{itemize}
\item {\tt L0HadronDecision\_TOS} OR {\tt Bu\_L0Global\_TIS}
\item \tt Hlt1TrackAllL0Decision\_TOS
\item \tt Hlt2Topo\{2,3 or 4\}BodyBBDTDecision\_TOS
\end{itemize}
%
Or the corresponding Run 2 triggers:

\begin{itemize}
\item {\tt L0HadronDecision\_TOS} OR {\tt Bu\_L0Global\_TIS}
\item {\tt Hlt1TrackMVADecision\_TOS} OR {\tt Bu\_Hlt1TwoTrackMVADecision\_TOS}
\item \tt Hlt2Topo\{2,3 or 4\}BodyDecision\_TOS
\end{itemize}

\subsection{Pre-selection}
\label{sec:selection:pre-selection}

Offline selections are applied to candidates passing the stripping and trigger in order to reduce the level of combinatoric background. In \lhcb\ \KS mesons can be reconstructed in two ways: including the \velo using long tracks, giving a better mass resolution, or using downstream tracks, with the first hits being collected in the TT. As the \KS reconstruction types have differing resolutions and selection efficiencies, LL and DD candidates are treated as separated datasets throughout the selection and a slightly different selection is applied to each. Firstly, rectangular cuts are applied, followed by a multivariate selection, and finally PID requirements. The DecayTreeFitter package~\cite{Hulsbergen:2005pu} is used to improve the $B^{\pm}$ mass resolution. The decay chain is refitted constraining the \Dz and \KS masses to their nominal values and constraining the $B^{\pm}$ to point to the primary vertex. The following rectangular cuts applied straight after stripping:

\begin{itemize}
\item 0 $<$ Bu DTF vertex fit $\chi^2$ $<$ 100
\item 0 $<$ Bu IP $\chi^2$ $<$ 100
\item 25 MeV \Dz mass window, i.e. \textbar \Dz mass - PDG value \textbar $<$ 25 \mev
\item 75 MeV \Kstarm mass window
\item 15 MeV \KS mass window for LL candidates, 20 MeV for DD candidates
\end{itemize}

\subsection{Multivariate analysis with a Boosted Decision Tree (BDT)}
\label{sec:selection:bdt}

A single BDT~\cite{Breiman} with the gradient boost (BDTG) method using the TMVA framework is employed in order to reduce the combinatoric background level. A separate BDT is trained for LL and DD candidates, named BDTG\_LL and BDTG\_DD. Also, a different BDT is used for the two body and four body modes. For the two body modes, Sim08 2011 and 2012 MC samples for the decay $B^{\pm} \to [K^{\pm}\pi^{\mp}]_D K^{*\pm}$ with generator level cuts applied, detailed in Section \ref{sec:mc:tmva}, were used to provide a signal sample. High mass sideband region of the B mass (above 5600 MeV) in the favoured $B^{\pm} \to [K^{\pm}\pi^{\mp}]_D K^{*\pm}$ mode, from 2011 and 2012 data, was used as a sample of background combinatoric events. The MC used to calculate signal efficiencies is signal MC with no generator level cuts applied. For the four body modes, a signal sample of Sim09b 2015 and 2016 MC samples for the decay $B^{\pm} \to [K^{\pm}\pi^{\mp}\pi^{\pm}\pi^{\mp}]_D K^{*\pm}$ was used. High mass sideband region of the B mass (above 5600 MeV) in the favoured $B^{\pm} \to [K^{\pm}\pi^{\mp}\pi^{\pm}\pi^{\mp}]_D K^{*\pm}$ mode, from 2015 and 2016 data, was used as a sample of background combinatoric events. All samples used in training the BDTs are split into a training and testing sample before being used as an input in TMVA by separating odd and even event numbers.

Pre-selection is applied to these training samples to allow a more accurate discrimination between signal and background in data. The pre-selection applied is slightly looser to that in Section \ref{sec:selection:pre-selection} to provide a larger sample in order to avoid overtraining of the BDT. The training samples had the following pre-selection applied:

\begin{itemize}
\item{0 $<$ Bu DTF vertex fit $\chi^2$ $<$ 100}
\item{0 $<$ Bu IP $\chi^2$ $<$ 100}
\item{500 MeV \Kstarm mass window}
\item{15 MeV \KS mass window for LL candidates, 20 MeV for DD candidates}
\end{itemize}

The variables used in the BDT, listed in Table \ref{BDTinputvariables}, are slightly different for LL and DD candidates, as the separation power of various \KS variables significantly differs between LL and DD candidates. One of the variables, used in both BDTs, which has a good separation power is the $p_T$ asymmetry of the B candidate (Bu ptasy 1.50). This is defined as the asymmetry between the $p_T$ of the B candidate and the $p_T$ of all other tracks in a cone of radius 1.50 around the B candidate, as shown in Equation \ref{ptasy}. This gives a quantitative measure of the track isolation of the B candidate. 

\begin{equation}
A_{p_T} = \frac{p_T^B - p_T^{cone}}{p_T^B + p_T^{cone}}
\label{ptasy}
\end{equation}

The distributions of the BDT input variables in the training signal and training background are shown in Figures \ref{BDTinputdist2bodyLL} and \ref{BDTinputdist2bodyDD}, for the two body BDTs and in Figures \ref{BDTinputdist4bodyLL} and \ref{BDTinputdist4bodyDD}, for the four body BDTs. The ranking of BDT variables is shown in Figure \ref{variableranking2body} and \ref{variableranking4body}. The signal and background output distributions of the BDT are shown in Figure \ref{BDTovertraining}. The training and testing distributions are in reasonable agreement, showing that the BDT is safe from overtraining effects.

\begin{table}[h]
\centering
\begin{tabular}{|l|l|}
\hline
BDT input variables (LL) & BDT input variables (DD) \\
\hline
log(Bu DTF $\chi^2/ndof$) & log(Bu DTF $\chi^2/ndof$) \\
Bu ptasy 1.50 & Bu ptasy 1.50 \\
log(Bu IP $\chi^2$ OWNPV) & log(Bu IP $\chi^2$ OWNPV) \\
log(Bach IP $\chi^2$ OWNPV) & log(Bach IP $\chi^2$ OWNPV) \\
log(\Dz IP $\chi^2$ OWNPV) & log(\Dz IP $\chi^2$ OWNPV) \\
{\color{blue}log(\Dz daughter kaon IP $\chi^2$ OWNPV)} & {\color{blue}log(\Dz daughter kaon IP $\chi^2$ OWNPV)} \\
{\color{blue}log(\Dz daughter pion IP $\chi^2$ OWNPV)} & {\color{blue}log(\Dz daughter pion IP $\chi^2$ OWNPV)} \\
{\color{red}log(\Dz daughter kaon IP $\chi^2$ OWNPV)} & {\color{red}log(\Dz daughter kaon IP $\chi^2$ OWNPV)} \\
{\color{red}log(\Dz daughter SS pion IP $\chi^2$ OWNPV)} & {\color{red}log(\Dz daughter SS pion IP $\chi^2$ OWNPV)} \\
{\color{red}log(\Dz daughter pion max(IP $\chi^2$ OWNPV))} & {\color{red}log(\Dz daughter pion max(IP $\chi^2$ OWNPV))} \\
{\color{red}log(\Dz daughter pion min(IP $\chi^2$ OWNPV))} & {\color{red}log(\Dz daughter pion min(IP $\chi^2$ OWNPV))} \\
log(\KS IP $\chi^2$ OWNPV) & \KS $p_T$ \\
log(\KS daughters max(IP $\chi^2$ OWNPV)) &  \\
log(\KS daughters min(IP $\chi^2$ OWNPV)) &  \\
\hline
\end{tabular}
\caption{Table showing the input variables used in both the LL and DD BDT training. Variables in blue are only used in the 2-body BDT, whereas those in red are only used in the 4-body BDT. The variable name $Bach$ refers to the bachelor particle, the pion coming from the \Kstarm. D daughter SS refers to the pion of the same sign of the kaon. Bu DTF $\chi^2/ndof$ is the $\chi^2$ per degree of freedom of the refitted B vertex given the DTF constaints, Bu ptasy is the $p_T$ asymmetry of the B candidate (defined in Equation \ref{ptasy}) using a cone of radius 1.50, and for a given particle IP $\chi^2$ OWNPV is the difference in the vertex fit $\chi^2$ of the PV with and without the particle under consideration.}
\label{BDTinputvariables}
\end{table}

\begin{figure}[tb]
\includegraphics[width=\linewidth]{figures/selection/inputvariables_KPi_LL_run1_1.pdf}
\includegraphics[width=\linewidth]{figures/selection/inputvariables_KPi_LL_run1_2.pdf}
\caption{BDT input variable distributions for signal and background for 2-body LL}
\label{BDTinputdist2bodyLL}
\end{figure}

\begin{figure}[tb]
\includegraphics[width=\linewidth]{figures/selection/inputvariables_KPi_DD_run1_1.pdf}
\includegraphics[width=\linewidth]{figures/selection/inputvariables_KPi_DD_run1_2.pdf}
\caption{BDT input variable distributions for signal and background for 2-body DD}
\label{BDTinputdist2bodyDD}
\end{figure}

\begin{figure}
\begin{verbatim}
BDTG_LL
-------------------------------------------------------------------------
Rank : Variable                                : Variable Importance
-------------------------------------------------------------------------
   1 : log(Bu_D0constKS0constPVconst_CHI2NDOF) : 1.396e-01
   2 : log(Ks_IPCHI2_OWNPV)                    : 1.266e-01
   3 : log(max_Ksh_IPCHI2_OWNPV)               : 1.024e-01
   4 : Bu_ptasy_1.50                           : 9.928e-02
   5 : log(Dh1_IPCHI2_OWNPV)                   : 9.739e-02
   6 : log(Bach_IPCHI2_OWNPV)                  : 9.650e-02
   7 : log(D0_IPCHI2_OWNPV)                    : 8.777e-02
   8 : log(min_Ksh_IPCHI2_OWNPV)               : 8.699e-02
   9 : log(Dh2_IPCHI2_OWNPV)                   : 8.290e-02
  10 : log(Bu_IPCHI2_OWNPV)                    : 8.056e-02
-------------------------------------------------------------------------

BDTG_DD
-------------------------------------------------------------------------
Rank : Variable                                : Variable Importance
-------------------------------------------------------------------------
   1 : log(Bu_D0constKS0constPVconst_CHI2NDOF) : 1.459e-01
   2 : log(Dh1_IPCHI2_OWNPV)                   : 1.287e-01
   3 : log(Bach_IPCHI2_OWNPV)                  : 1.280e-01
   4 : Bu_ptasy_1.50                           : 1.260e-01
   5 : log(Dh2_IPCHI2_OWNPV)                   : 1.214e-01
   6 : log(D0_IPCHI2_OWNPV)                    : 1.174e-01
   7 : log(Bu_IPCHI2_OWNPV)                    : 1.171e-01
   8 : Ks_PT                                   : 1.155e-01
-------------------------------------------------------------------------
\end{verbatim}
\caption{Ranking for variables for BDTG\_LL and BDTG\_DD for the two body BDTs}
\label{variableranking2body}
\end{figure}

\begin{figure}[tb]
\includegraphics[width=\linewidth]{figures/selection/inputvariables_KPiPiPi_LL_run2_1.pdf}
\includegraphics[width=\linewidth]{figures/selection/inputvariables_KPiPiPi_LL_run2_2.pdf}
\caption{BDT input variable distributions for signal and background for 4-body LL}
\label{BDTinputdist4bodyLL}
\end{figure}

\begin{figure}[tb]
\includegraphics[width=\linewidth]{figures/selection/inputvariables_KPiPiPi_DD_run2_1.pdf}
\includegraphics[width=\linewidth]{figures/selection/inputvariables_KPiPiPi_DD_run2_2.pdf}
\caption{BDT input variable distributions for signal and background for 4-body DD}
\label{BDTinputdist4bodyDD}
\end{figure}

\begin{figure}
\begin{verbatim}
BDTG_LL
-------------------------------------------------------------------------
Rank : Variable                                : Variable Importance
-------------------------------------------------------------------------
   1 : log(Bu_D0constKS0constPVconst_CHI2NDOF) : 1.109e-01
   2 : log(Ks_IPCHI2_OWNPV)                    : 1.028e-01
   3 : Bu_ptasy_1.50                           : 9.283e-02
   4 : log(Bu_IPCHI2_OWNPV)                    : 8.911e-02
   5 : log(D0_IPCHI2_OWNPV)                    : 8.245e-02
   6 : log(Dh1_IPCHI2_OWNPV)                   : 7.997e-02
   7 : log(Bach_IPCHI2_OWNPV)                  : 7.899e-02
   8 : log(min_Dh_IPCHI2_OWNPV)                : 7.513e-02
   9 : log(max_Ksh_IPCHI2_OWNPV)               : 7.480e-02
  10 : log(Dhss_IPCHI2_OWNPV)                  : 7.469e-02
  11 : log(min_Ksh_IPCHI2_OWNPV)               : 7.295e-02
  12 : log(max_Dh_IPCHI2_OWNPV)                : 6.546e-02
-------------------------------------------------------------------------

BDTG_DD
-------------------------------------------------------------------------
Rank : Variable                                : Variable Importance
-------------------------------------------------------------------------
   1 : log(Bu_D0constKS0constPVconst_CHI2NDOF) : 1.251e-01
   2 : Bu_ptasy_1.50                           : 1.108e-01
   3 : log(Bu_IPCHI2_OWNPV)                    : 1.080e-01
   4 : log(Bach_IPCHI2_OWNPV)                  : 1.056e-01
   5 : Ks_PT                                   : 1.054e-01
   6 : log(D0_IPCHI2_OWNPV)                    : 1.052e-01
   7 : log(max_Dh_IPCHI2_OWNPV)                : 9.205e-02
   8 : log(Dhss_IPCHI2_OWNPV)                  : 8.864e-02
   9 : log(Dh1_IPCHI2_OWNPV)                   : 8.393e-02
  10 : log(min_Dh_IPCHI2_OWNPV)                : 7.533e-02
-------------------------------------------------------------------------
\end{verbatim}
\caption{Ranking for variables for BDTG\_LL and BDTG\_DD for the four body BDTs}
\label{variableranking4body}
\end{figure}

\begin{figure}[tb]
\includegraphics[width=0.5\linewidth]{figures/selection/overtraining_KPi_LL_run1.pdf}
\put(-150,100) {(a)}
\hfill
\includegraphics[width=0.5\linewidth]{figures/selection/overtraining_KPi_DD_run1.pdf}
\put(-140,100) {(b)}
\hfill
\includegraphics[width=0.5\linewidth]{figures/selection/overtraining_KPiPiPi_LL_run2.pdf}
\put(-150,100) {(c)}
\hfill
\includegraphics[width=0.5\linewidth]{figures/selection/overtraining_KPiPiPi_DD_run2.pdf}
\put(-140,100) {(d)}
\caption{Training and test distributions from TMVA for (a) 2-body BDT\_LL, (b) 2-body BDT\_DD, (c) 4-body BDT\_LL and (d) 4-body BDT\_DD}
\label{BDTovertraining}
\end{figure}

Other selection strategies were explored. Multiple BDTs were investigated, by training and implementing a \KS BDT and a \Dz BDT followed by a B BDT. Two approaches were tried: one using the same set of variables in all three BDTs and one using variables relating to the \KS in the \KS BDT and variables relating to the \Dz in the \Dz BDT. These methods were found to have little or no improvement on the single BDT. Many other variables were investigated in the BDT, including kinematic variables of the B and D. These were found to give no significant improvement in BDT performance. A 2-body BDT trained on Run 2 data and MC was investigated to apply to Run 2 data, which did not result in any improvement in performance compared to the BDT trained on Run 1. Therefore, it was not considered necessary to have BDTs trained separately for Run 1 and Run 2.

For the 2-body BDTs, a BDT selection of 0.6 is chosen for BDT\_LL and 0.7 for BDT\_DD for all D modes except the ADS mode. The ADS mode BDT selection is chosen to be 0.6 for BDT\_LL and 0.9 for BDT\_DD. This tighter BDT selection is justified in Figure \ref{adsoptimisation}. When applied to the $K\pi$ favoured mode in Run 1 the BDT selection gives a 95\% signal efficiency and 96\% background rejection for LL and 88\% signal efficiency and 94\% background rejection for DD. The signal efficiencies of the BDT cuts are given in Table \ref{bdtefficiencies2body}. These BDT selections, in conjuction with the \Kstarm mass window and \KS helicity angle, were optimised to reduce the fit error on the physics observables, as detailed in Section \ref{sec:cpfit:optimisation}. Many toy studies were run to calculate the fit uncertainty for each selection. To optimise the selection for the GLW modes, the fit error was minimised for $A_{KK}$, $R_{KK}$, $A_{\pi\pi}$ and $R_{\pi\pi}$. The BDT selection for the ADS modes was optimised to minimise the fit errors in $R^+$ and $R^-$, as illustated in Figure \ref{adsoptimisation}. 

In cases when the figure of merits in these optimisation studies were not especially sensitive to changes in the selection, the selection giving the highest coherence (i.e most stringent requirement on the \Kstarm) was chosen and the BDT signal and background efficiencies were taken into account.

For the four-body modes the same optimisation point was chosen 0.6 for BDT\_LL and 0.7 for BDT\_DD for the \decay{\Dz}{\Kp\pim\pip\pim} \decay{\Dz}{\pi\pi\pi\pi} mode, and 0.6 for BDT\_LL and 0.9 for BDT\_DD for the \decay{\Dz}{\Kp\pim\pip\pim} mode. The optimisation point was verified by minimising the fit error in toys for $A_{K\pi\pi\pi}$, $R^+_{K\pi\pi\pi}$ and $R^-_{K\pi\pi\pi}$.


\subsection{Other cuts}

Some other selection requirements are implemented to tackle certain backgrounds.

\begin{itemize}
\item{\textbar $\cos$(Ks helicity angle) \textbar $>$ 0.3, discussed in Section \ref{sec:backgrounds:non-resonant}. This angle is defined as is the angle between the \KS and the bachelor pion in the \Kstarm rest frame}
\item{\Dz FD significance $>$ 2 is required to remove charmless backgrounds, discussed in Section \ref{sec:backgrounds:charmless}}
\item{\KS FD significance $>$ 5 (for LL candidates only) is required to remove $B \to D\pi\pi\pi$ background, discussed in Section \ref{sec:backgrounds:b2dpipipi}}
\item{15 MeV double misID veto, discussed further in Section \ref{sec:backgrounds:crossfeed}}
\begin{itemize}
\item For two-body: 15 MeV double misID veto is applied to $B^{\pm} \to [K^{\mp}\pi^{\pm}] K^{*\pm}$ only. The \Dz mass is reconstructed where both daughter mass hypotheses are swapped (kaon reconstructed as a pion and pion reconstructed as a kaon), this is required to be greater than 15 MeV away from the nominal \Dz mass.
\item For four-body: There are two possible pions that could be incorrectly reconstructed as a kaon, therefore two 15 MeV double misID vetos are applied to both the favoured and the supressed modes. 
\end{itemize} 
\end{itemize}


\subsection{PID selection}
\label{sec:selection:pid}

The selection requirements are identical for each of the different D modes, $K\pi$, $KK$, $\pi\pi$ and $\pi K$, with the exception of the double misID veto. Therefore, it is essential to apply PID selection that efficiently distinguishes between pions and kaons. The PID cuts on the daughters of the D meson are designed so that no \decay{\Dz}{hh} candidate can appear in more than one category with a change in mass hypothesis. A PID requirement must be made on the bachelor pion in order to remove the \decay{\B}{\D\KS\kaon} background; this is discussed in more detail in Section \ref{sec:backgrounds:b2dkks}. 

For the bachelor PID (pion coming from the \Kstarm) a requirement of PIDK $<$ 4 is applied. For the 2-body D modes the requirements on the D daughters are kaons must satisfy DLLK $>$ 2 and pions must satifsfy DLLK $<$ -2. For the \decay{\Dz}{K\pi\pi\pi} modes, e.g. \decay{\Dz}{\Km\pip\pim\pip}, the \Km must satisfy DLLK $>$ 2 and both \pip must satifsfy DLLK $<$ -2; no PID requirement is applied for the \pip. For the \decay{\Dz}{\pip\pim\pip\pim}, the two \pip mesons must satisfy DLLK $<$ -2 and no PID requirements is placed on the \pim mesons. The PID requirements are the same as those used in the \decay{\Bp}{\D\Kp} analysis~\cite{LHCb-PAPER-2016-003}. No PID requirements are made on the \KS daughters; the high purity of the \KS means that this is not necessary, this is justified in Section \ref{sec:backgrounds:contamination}. The efficiency of this PID selection for the $K\pi$ favoured mode in Run 1 is 74\% and the efficiency of $\pi K$ events in the favoured mode is 0.15\%. These efficiencies are discussed in more detail in Section \ref{sec:mc:pid}. 


A brief look at ProbNN variables was undertaken early on in the analysis but cuts were not found that improved on the DLL cuts. Figure \ref{pidoptimisation} shows the variation of PID efficiencies with different selections. These results are based on a preliminary version of the selection and so the DLLK efficiencies are not the same as those quoted in this analysis.  The same PID selection is applied to both Run 1 and Run 2 datasets. It was found that for the given PID selection both PID efficiency and misID efficiency were improved for Run 2 compared to Run 1. More detail is given in Section \ref{sec:mc:pid}.

\begin{figure}
\includegraphics[width=0.5\linewidth]{figures/selection/pidOptimisation_bachelor.pdf}
\put(-150,100) {(a)}
\hfill
\includegraphics[width=0.5\linewidth]{figures/selection/pidOptimisation_Ddaughters.pdf}
\put(-150,100) {(b)}
\caption{PID efficiencies and misID efficiencies for various PID selections applied to (a) the bachelor pion, and (b) the D daughters. The black curve is for selections using $DLLK$, the red curve is for selections using $ProbNNpi$ and the blue curve is for selections using $ProbNNpi \times (1-ProbNNk)$}
\label{pidoptimisation}
\end{figure}

\subsection{Multiple candidates}
\label{sec:selection:multiplecandidates}

The selection may produce more than one signal event from the same B candidate. The rate of these multiple candidates was calculated after the final selection and only considering candidates in the range of the \CP fit (refitted \B mass $>$ 5230 \mev), see Section \ref{sec:massfit:range} for details on the fit range. The results are shown in Tables \ref{multiplecandidatesRun1} and \ref{multiplecandidatesRun2}. The rate is so low that no action is taken to remove the multiple candidates. In the ADS mode where it would have a significant effect, there are no multiple candidates.

\begin{table}[h]
\centering
\begin{tabular}{ccc}
\hline
& LL & DD \\
\hline
$K\pi$ & 0.005 (4) & 0.004 (9) \\
$K\pi$ & 0.008 (2) & 0.005 (3) \\
$KK$ & 0 (0) & 0 (0) \\
$\pi\pi$ & 0 (0) & 0 (0) \\
$\pi K$ & 0 (0) & 0 (0) \\
$K\pi\pi\pi$ & 0 (0) & 0.026 (7) \\
$\pi K\pi\pi$ & 0 (0) & 0.05 (1) \\
\hline
\end{tabular}
\caption{Multiple candidate rate for Run1. The number in brackets is the actual number of multiple candidates}
\label{multiplecandidatesRun1}
\end{table}

\begin{table}[h]
\centering
\begin{tabular}{ccc}
\hline
& LL & DD \\
\hline
$K\pi$ & 0.005 (7) & 0.005 (19) \\
$K\pi$ & 0.005 (2) & 0.004 (5) \\
$KK$ & 0 (0) & 0.006 (1) \\
$\pi\pi$ & 0 (0) & 0.011 (1) \\
$\pi K$ & 0 (0) & 0 (0) \\
$K\pi\pi\pi$ & 0 (0) & 0.012 (9) \\
$\pi K\pi\pi$ & 0 (0) & 0 (0) \\
\hline
\end{tabular}
\caption{Multiple candidate rate for Run 2. The number in brackets is the actual number of multiple candidates}
\label{multiplecandidatesRun2}
\end{table}

\clearpage

\section{Mass parameterisation of the favoured mode}
\label{sec:massfit}

The fit to data is performed on the invariant mass of B candidates. Firstly a fit model was developed and applied to the favoured mode, namely \decay{\Bm}{\D(\Km\pip)\Kstarm}.

\subsection{Signal shape}
\label{sec:massfit:signal}

The signal shape is constructed using the sum of two Crystal Ball (CB) functions~\cite{Skwarnicki:1986xj}, where the tail parameters, $\alpha$ and $n$, are fixed from MC and both CBs share the same mean and tail parameters. This Double Crystal Ball shape is defined in Equation \ref{DCBshape}. The width fraction between the CBs, $f_{\sigma}$, is fixed from MC, but the mean and width, $\mu$ and $\sigma$, are left floating. 

\begin{equation}
\mathrm{DCB}(m; \mu,\sigma,\alpha,n,f_{cb}) = f_{cb} \cdot \mathrm{CB}(m; \mu,\sigma,\alpha,n) + (1-f_{cb}) \cdot \mathrm{CB}(m;\mu,f_{\sigma}\sigma,\alpha,n),
\label{DCBshape}
\end{equation}
where
\begin{equation*}
  \mathrm{CB}(m; \mu,\sigma,\alpha,n)=
\begin{cases}
    e^{-((m-\mu)/ \sigma)^2/2},                                   & \text{if } \frac{m-\mu}{\sigma} \geq - \alpha, \\
   \left ( \frac{n}{|\alpha|} \right ) ^n e^{-|\alpha|^2/2} \left ( \frac{n}{|\alpha|} - |\alpha| - \left ( \frac{m-\mu}{\sigma} \right ) \right ) ^{-n} ,    & \text{otherwise.}
\end{cases}
\end{equation*}


The fits to signal MC are shown in Figure \ref{signalfits} and the shape parameters obtained from these fits are detailed in Table \ref{signalparameters}. 
%The fitted mean value in data and MC was found to be slightly different, the values of the differences are shown in Table \ref{mcshifts}.

\begin{figure}[h]
\includegraphics[width=0.5\linewidth]{figures/fitComponents/signalShape_LL_KPi.pdf}
\includegraphics[width=0.5\linewidth]{figures/fitComponents/signalShape_DD_KPi.pdf}
\put(-400,70) {(a)}
\put(-180,70) {(b)}
\hfill
\includegraphics[width=0.5\linewidth]{figures/fitComponents/signalShape_LL_KPiPiPi.pdf}
\includegraphics[width=0.5\linewidth]{figures/fitComponents/signalShape_DD_KPiPiPi.pdf}
\put(-400,70) {(c)}
\put(-180,70) {(d)}
\caption{Fits to signal MC for (a) $K\pi$ LL, (b) $K\pi$ DD, (c) $K\pi\pi\pi$ LL, and (d) $K\pi\pi\pi$ DD}
\label{signalfits}
\end{figure}

\begin{table}[h]
\centering
\begin{tabular}{c|cc|cc}
\hline
& \multicolumn{2}{c}{$K\pi$} & \multicolumn{2}{c}{$K\pi\pi\pi$} \\
& LL & DD & LL & DD\\
\hline
$\mu$ & $5279.12 \pm 0.15$ & $5279.30 \pm 0.09$ & $5279.62 \pm 0.12$ & $5279.50 \pm 0.19$ \\
$\sigma$ & $10.7 \pm 0.3$ & $10.8 \pm 0.2$ & $11.2 \pm 0.2$ & $11.6 \pm 0.3$ \\
$f_{\sigma}$ & $2.04 \pm 0.10$ & $1.97 \pm 0.06$ & $2.08 \pm 0.07$ & $2.10 \pm 0.11$ \\
$\alpha$ & $2.53 \pm 0.07$ & $2.46 \pm 0.04$ & $2.60 \pm 0.07$ & $2.50 \pm 0.10$ \\
$n$ & 1.0 (fixed) & 1.0 (fixed) & 1.0 (fixed) & 1.0 (fixed) \\
$f_{cb}$ & $0.82 \pm 0.03$ & $0.84 \pm 0.02$ & $0.80 \pm 0.03$ & $0.81 \pm 0.04	$ \\
\hline
\end{tabular}
\caption{Signal shape parameters obtained by a fit to Run 1 and Run 2 signal MC combined for both $K\pi$ and $K\pi\pi\pi$. Parameter names are defined in Equation \ref{DCBshape}. All parameters except for the mean and width are fixed to these values in the mass fit}
\label{signalparameters}
\end{table}

%\begin{table}
%\centering
%\begin{tabular}{ccc}
%\hline
%& Run 1 & 2015 \\
%\hline
%LL & +1.5 & +1.2 \\
%DD & +0.4 & 0.0 \\
%\hline
%\end{tabular}
%\caption{Difference (in MeV) in the fitted value of the mean between data and MC (data - MC)}
%\label{mcshifts}
%\end{table}


\subsection{Combinatorial background}
\label{sec:massfit:combinatorial}

The combinatoric background is modelled using an exponential function with a freely floating slope parameter and yield. The slope parameter is allowed to float independently in the LL and DD categories and between 2 and 4 body D final states. Each D final state can have a different combinatoric rate.


%%%%%%%%%%%%%%%%%%%%%%
\subsection{Partially reconstructed backgrounds}
\label{sec:massfit:partreco}

The partially reconstructed decays are of the form \decay{\B}{\Dstar\Kstar}, where the \Dstar decays to a \D meson and a pion or photon that is missed in reconstruction. These backgrounds are observed at a low reconstructed invariant mass due to the single particle missed from the invariant mass sum. Three partially reconstructed decays contribute in the invariant mass fit:

\begin{itemize}
\item{\decay{\Bm}{(\decay{\Dstarz}{\Dz[\piz]})\Kstarm}}
\item{\decay{\Bm}{(\decay{\Dstarz}{\Dz[\gamma]})\Kstarm}}
\item{\decay{\Bd}{(\decay{\Dstarp}{\Dz[\pip]})\Kstarm}}
\end{itemize}

where the particle in square brackets corresponds to the missing daughter. All of the decay modes listed are modelled using three analytic PDFs; RooHORNSdini, RooHILLdini and RooLITTLEHORNSdini. These PDFs are physically motivated, exploiting the decay kinematics of partially reconstructed decays. These PDFs are described in more detail in the \decay{\Bz}{\D	\Kstarz} GGSZ analysis note~\cite{B02DKst0_GGSZ}.

\decay{\Bm}{\Dstarp\Kstarm} is a Scalar $\to$ Vector Vector decay, therefore there are three different helicity amplitudes to consider due to the conservation of angular momentum. Each of these helicity amplitudes produces a \Dstar particle in a different helicity state. The three helicity amplitudes are referred to as 001, 010 and 100, which correspond to helicity states shown in Table \ref{helicityamplitudes}. 

\begin{table}[h]
\centering
\begin{tabular}{c|ccc}
\hline
& B (J=0) & \Dstar (J=1) & \Kstar (J=1) \\
\hline
001 & 0 & -1 & +1 \\
010 & 0 & 0 & 0 \\
100 & 0 & +1 & -1 \\
\end{tabular}
\caption{Possible helicity amplitudes of the \decay{\B}{\Dstar\Kstar} decay. The numbers in the table correspond $J_z$ values}
\label{helicityamplitudes}
\end{table}

The \B mass distribution of these decays depends on the helicity amplitude of the decay and the spin of the missing particle. For each decay amplitude the spin of the helicity angle of the missing particle has a one-to-one correspondance with the missing momentum and therefore to the reconstructed \B mass. 

The \B mass distribution will not only depend on the physics of the decay but also on selection and reconstruction effects. Reconstruction and selection favours decays with higher reconstructed \B mass, the selection efficiency can be modelled by linear function with a slope parameter. In order to model detector effects, the shapes are convolved with a resolution function, described by a double Gaussian.

For each partially reconstructed background, the generated MC for 001 and 100 helicity amplitudes is physically indistiguishable in B mass and so these are combined to form a 101 helicity ampltiude. For each shape 1M events were generated and stripping and selection was applied, except for the PID selection. The shapes are taken from MC are fitted separately using the RooHORNSdini, RooHILLdini and RooLITTLEHORNSdini, the fits are shown in Figures \ref{partrecofitsLL} and \ref{partrecofitsDD}. All the parameters for these shapes are fixed in the mass fit from fits to MC.

\begin{figure}[h]
\includegraphics[width=0.5\linewidth]{figures/fitComponents/Bupi010_LL.pdf}
\put(-180,80) {(a)}
\includegraphics[width=0.5\linewidth]{figures/fitComponents/Bupi101_LL.pdf}
\put(-180,80) {(b)}
\hfill
\includegraphics[width=0.5\linewidth]{figures/fitComponents/Bugamma010_LL.pdf}
\put(-180,80) {(c)}
\includegraphics[width=0.5\linewidth]{figures/fitComponents/Bugamma101_LL.pdf}
\put(-180,80) {(d)}
\hfill
\includegraphics[width=0.5\linewidth]{figures/fitComponents/Bdpi010_LL.pdf}
\put(-180,80) {(e)}
\includegraphics[width=0.5\linewidth]{figures/fitComponents/Bdpi101_LL.pdf}
\put(-180,80) {(f)}
\caption{Fit to $B \to D^*K^*$ Run 1 MC in all the different modes for LL candidates (a) \decay{\Bm}{(\decay{\Dstarz}{\Dz[\piz]})\Kstarm} 010, (b) \decay{\Bm}{(\decay{\Dstarz}{\Dz[\piz]})\Kstarm} 101, (c) \decay{\Bm}{(\decay{\Dstarz}{\Dz[\gamma]})\Kstarm} 010, (d) \decay{\Bm}{(\decay{\Dstarz}{\Dz[\gamma]})\Kstarm} 101, (e) \decay{\Bd}{(\decay{\Dstarp}{\Dz[\pip]})\Kstarm} 010, and (f) \decay{\Bd}{(\decay{\Dstarp}{\Dz[\pip]})\Kstarm} 101}
\label{partrecofitsLL}
\end{figure}

\begin{figure}
\includegraphics[width=0.5\linewidth]{figures/fitComponents/Bupi010_DD.pdf}
\put(-180,80) {(a)}
\includegraphics[width=0.5\linewidth]{figures/fitComponents/Bupi101_DD.pdf}
\put(-180,80) {(b)}
\hfill
\includegraphics[width=0.5\linewidth]{figures/fitComponents/Bugamma010_DD.pdf}
\put(-180,80) {(c)}
\includegraphics[width=0.5\linewidth]{figures/fitComponents/Bugamma101_DD.pdf}
\put(-180,80) {(d)}
\hfill
\includegraphics[width=0.5\linewidth]{figures/fitComponents/Bdpi010_DD.pdf}
\put(-180,80) {(e)}
\includegraphics[width=0.5\linewidth]{figures/fitComponents/Bdpi101_DD.pdf}
\put(-180,80) {(f)}
\caption{Fit to $B \to D^*K^*$ Run 1 MC in all the different modes for DD candidates (a) \decay{\Bm}{(\decay{\Dstarz}{\Dz[\piz]})\Kstarm} 010, (b) \decay{\Bm}{(\decay{\Dstarz}{\Dz[\piz]})\Kstarm} 101, (c) \decay{\Bm}{(\decay{\Dstarz}{\Dz[\gamma]})\Kstarm} 010, (d) \decay{\Bm}{(\decay{\Dstarz}{\Dz[\gamma]})\Kstarm} 101, (e) \decay{\Bd}{(\decay{\Dstarp}{\Dz[\pip]})\Kstarm} 010, and (f) \decay{\Bd}{(\decay{\Dstarp}{\Dz[\pip]})\Kstarm} 101}
\label{partrecofitsDD}
\end{figure}

As there are six shapes in this low mass region of the mass fit, from 4900-5230 MeV, it is necessary to fix some yields in order to have a stable fit. The yield ratios between \decay{\Bm}{(\decay{\Dstarz}{\Dz[\piz]})\Kstarm}, \decay{\Bm}{(\decay{\Dstarz}{\Dz[\gamma]})\Kstarm} and \decay{\Bd}{(\decay{\Dstarp}{\Dz[\pip]})\Kstarm} are fixed separately for the 010 and 101 helicity amplitudes. The values fixed in the fit, given in Table \ref{fixedyieldratios}, are obtained from a ratio of braching fractions and selection efficiencies, an example calculation is given in Equation \ref{partrecoexample}. This calculation is performed for each of the ratios listed in Table \ref{fixedyieldratios}. Branching fractions for the partially reconstructed decays are given in Table \ref{partrecoBRs}. MC events are generated for each of the modes and the values of $\epsilon_{sel}$, used in Equation \ref{partrecoexample}, are given by the fraction of MC events passing the selection.

\begin{equation}
\frac{N(\decay{\B}{(\decay{\Dstar}{\Dz\piz})\Kstar}\ 010)}{N(\decay{\B}{(\decay{\Dstar}{\Dz\gamma})\Kstar}\ 010)} = \frac{BR(\decay{\B}{(\decay{\Dstar}{\Dz\piz})\Kstar})}{BR(\decay{\B}{(\decay{\Dstar}{\Dz\gamma})\Kstar})} \times \frac{\epsilon_{sel}(\decay{\B}{(\decay{\Dstar}{\Dz\piz})\Kstar}\ 010)}{\epsilon_{sel}(\decay{\B}{(\decay{\Dstar}{\Dz\gamma})\Kstar}\ 010)}
\label{partrecoexample}
\end{equation}

\begin{table}[h]
\centering
\begin{tabular}{c|c}
Mode & Branching ratio \\
\hline
\decay{\Bm}{(\decay{\Dstarz}{\Dz[\piz]})\Kstarm} & $(5.0 \pm 0.9) \times 10^{-4}$ \\
\decay{\Bm}{(\decay{\Dstarz}{\Dz[\gamma]})\Kstarm} & $(3.1 \pm 0.6) \times 10^{-4}$ \\
\decay{\Bd}{(\decay{\Dstarp}{\Dz[\pip]})\Kstarm} & $(2.2 \pm 0.4) \times 10^{-4}$ \\
\end{tabular}
\caption{Branching ratios for the different partially reconstructed decay modes~\cite{PDG2014}}
\label{partrecoBRs}
\end{table}

\begin{table}
\centering
\begin{tabular}{ccc}
\hline
& LL & DD \\
\hline
$\frac{Bu \gamma 010}{Bu \pi 010}$ & $0.53 \pm 0.14$ & $0.51 \pm 0.14$ \\[3mm]
$\frac{Bd \pi 010}{Bu \pi 010}$ & $0.38 \pm 0.14$ & $0.37 \pm 0.14$ \\[3mm]
$\frac{Bu \gamma 101}{Bu \pi 101}$ & $0.53 \pm 0.14$ & $0.51 \pm 0.14$ \\[3mm]
$\frac{Bd \pi 101}{Bu \pi 101}$ & $0.38 \pm 0.14$ & $0.38 \pm 0.14$ \\[3mm]
\hline
\end{tabular}
\caption{Yield ratios fixed in the mass fit for the partically reconstructed backgrounds}
\label{fixedyieldratios}
\end{table}

Other backgrounds investigated in this analysis, but not included in the mass fit are discussed in Section \ref{sec:backgrounds}.


\subsection{Mass fit}
\label{sec:massfit:fit}

A fit to the invariant B mass in the $K\pi$ and $K\pi\pi\pi$ favoured mode is performed using the shapes discussed in Sections \ref{sec:massfit:signal}, \ref{sec:massfit:combinatorial} and \ref{sec:massfit:partreco}. The yield of the signal and combinatoric shape are left to float without constraint. There are six shapes in the partially reconstructed background. The yield ratios between all the shapes with helicity amplitude 010 and yield ratios between the shapes with helicity amplitude 101 are fixed to the values detailed in Table \ref{fixedyieldratios}. The only parameters left floating in the partially reconstructed background are the yield ratio between the 010 and 101 amplitudes and the overall yield. 

Figures \ref{massfitskpi} and \ref{massfitsk3pi} shows the fits to the invariant B mass distribution in the $K\pi$ and $K\pi\pi\pi$ favoured mode respectively for LL and DD candidates in both Run 1 and Run 2. The estimated $K\pi$ signal yield extracted from these fits for Run 1 is $220 \pm 16$ for LL and $505 \pm 24$ for DD, and for Run 2 is $388 \pm 21$ for LL and $901 \pm 33$ for DD. The fit results are shown in Table \ref{fitresultskpi}. For the $K\pi\pi\pi$ mode, the estimated signal yield extracted from these fits for Run 1 is $87 \pm 10$ for LL and $205 \pm 16$ for DD, and for Run 2 is $215 \pm 15$ for LL and $516 \pm 25$ for DD. The fit results are shown in Table \ref{fitresultsk3pi}.

\begin{figure}
\centering
\subfloat[Run 1 LL]{\includegraphics[width=0.7\linewidth]{figures/fitComponents/massFit_LL_KPi_run1.pdf}}
\vspace{-12pt}
\hfill
\subfloat[Run 1 DD]{\includegraphics[width=0.7\linewidth]{figures/fitComponents/massFit_DD_KPi_run1.pdf}}
\vspace{-12pt}
\hfill
\subfloat[Run 2 LL]{\includegraphics[width=0.7\linewidth]{figures/fitComponents/massFit_LL_KPi_run2.pdf}}
\vspace{-12pt}
\hfill
\subfloat[Run 2 DD]{\includegraphics[width=0.7\linewidth]{figures/fitComponents/massFit_DD_KPi_run2.pdf}}
\caption{Fits to the invariant B mass distribution in the $K\pi$ favoured mode}
\label{massfitskpi}
\end{figure}

\begin{figure}
\centering
\subfloat[Run 1 LL]{\includegraphics[width=0.7\linewidth]{figures/fitComponents/massFit_LL_KPiPiPi_run1.pdf}}
\vspace{-12pt}
\hfill
\subfloat[Run 1 DD]{\includegraphics[width=0.7\linewidth]{figures/fitComponents/massFit_DD_KPiPiPi_run1.pdf}}
\vspace{-12pt}
\hfill
\subfloat[Run 2 LL]{\includegraphics[width=0.7\linewidth]{figures/fitComponents/massFit_LL_KPiPiPi_run2.pdf}}
\vspace{-12pt}
\hfill
\subfloat[Run 2 DD]{\includegraphics[width=0.7\linewidth]{figures/fitComponents/massFit_DD_KPiPiPi_run2.pdf}}
\caption{Fits to the invariant B mass distribution in the $K\pi$ favoured mode}
\label{massfitsk3pi}
\end{figure}

\begin{table}[h]
\centering
\begin{tabular}{l|cc|cc}
\hline
& \multicolumn{2}{c}{Run 1} & \multicolumn{2}{c}{Run 2} \\
& LL & DD & LL & DD \\
\hline
decay & $(-4.8 \pm 0.5) \times 10^{-3}$ & $(-2.8 \pm 0.3) \times 10^{-3}$ & $(-4.4 \pm 0.5) \times 10^{-3}$ & $(-2.5 \pm 0.2) \times 10^{-3}$ \\
frac\_010 & $0.15 \pm 0.08$ & $0.12 \pm 0.05$ & $0.18 \pm 0.05$ & $0.06 \pm 0.04$ \\
mean & $5280.7 \pm 0.8$ & $5280.7 \pm 0.6$ & $5278.5 \pm 0.8$ & $5278.6 \pm 0.5$ \\
nbkg & $167 \pm 20$ & $472 \pm 34$ & $223 \pm 24$ & $1100 \pm 50$ \\
ndstkst & $338 \pm 23$ & $810 \pm 36$ & $654 \pm 31$ & $1397 \pm 49$ \\
nsig & $220 \pm 16$ & $505 \pm 24$ & $388 \pm 21$ & $901 \pm 33$ \\
sigma & $10.2 \pm 0.7$ & $11.5 \pm 0.5$ & $12.2 \pm 0.6$ & $11.5 \pm 0.4$ \\
\hline
\end{tabular}
\caption{Fit results from the $K\pi$ favoured mode for LL and DD candidates, corresponding to the fits in Figure \ref{massfitskpi}. The parameter $decay$ is the combinatoric background slope, $frac\_010$ is the yield ratio between 010 and 101 helicity amplitudes, $sigma$ is the floating width of the signal shape, and $nsig$, $nbkg$ and $ndstkst$ are the yields of signal, combinatoric background and partially reconstructed decays respectively}
\label{fitresultskpi}
\end{table}

\begin{table}[h]
\centering
\begin{tabular}{l|cc|cc}
\hline
& \multicolumn{2}{c}{Run 1} & \multicolumn{2}{c}{Run 2} \\
& LL & DD & LL & DD \\
\hline
decay & $(-5.2 \pm 1.1) \times 10^{-3}$ & $(-2.3 \pm 0.4) \times 10^{-3}$ & $(-4.4 \pm 0.5) \times 10^{-3}$ & $(-2.1 \pm 0.2) \times 10^{-3}$ \\
frac\_010 & $0.26 \pm 0.11$ & $0.20 \pm 0.08$ & $0.15 \pm 0.07$ & $0.16 \pm 0.05$ \\
mean & $5281.3 \pm 1.3$ & $5283.9 \pm 0.9$ & $5278.7 \pm 1.0$ & $5277.7 \pm 0.7$ \\
nbkg & $50 \pm 12$ & $252 \pm 24$ & $168 \pm 20$ & $707 \pm 40$ \\
ndstkst & $154 \pm 15$ & $317 \pm 24$ & $342 \pm 23$ & $914 \pm 40$ \\
nsig & $102 \pm 10$ & $226 \pm 16$ & $244 \pm 16$ & $578 \pm 27$ \\
sigma & $11.4 \pm 1.0$ & $11.3 \pm 0.8$ & $12.9 \pm 0.8$ & $13.1 \pm 0.6$ \\
\hline
\end{tabular}
\caption{Fit results from the $K\pi\pi\pi$ favoured mode for LL and DD candidates, corresponding to the fits in Figure \ref{massfitsk3pi}. The parameter $decay$ is the combinatoric background slope, $frac\_010$ is the yield ratio between 010 and 101 helicity amplitudes, $sigma$ is the floating width of the signal shape, and $nsig$, $nbkg$ and $ndstkst$ are the yields of signal, combinatoric background and partially reconstructed decays respectively}
\label{fitresultsk3pi}
\end{table}

%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Choice of fit range}
\label{sec:massfit:range}	

Fixing the relative yields for the partially reconstructed shapes, as in Table \ref{fixedyieldratios}, is possible only under the assumption that \CP violation is negligible. This is a fair assumption for the favoured \decay{\Dz}{\Km\pip} decay, however in the other \D modes, for example \decay{\Dz}{\Kp\Km}, there is expected \CP violation for which the parameters are entirely unknown. Therefore, it is not possible make any constraints at all in these modes. The fit that would result from fitting six individual yields with an order of magnitude less data would be unstable and this lack of constraint in the low mass region would lead to a large amount of freedom in the combinatoric, significantly affecting the signal yield. 

The overlap of the partially reconstructed and signal peaks is very small. There are a number of advantages to raising the lower range of the mass parameterisation up to 5230 \mev, which only removes 0.4\% of signal. The advantages include avoiding the need to fit the various partially reconstructed yields in each of the other D decays modes. These cannot use the same assumptions and fractions as determined in the Cabibbo-favoured mode due to expected CP violation. Further benefits are that low level broad backgrounds that may be present in the range 4900 - 5200 \mev do not need to considered as sources of systematics uncertainty. The shape and yield of the small amount of partially reconstructed background present in all \D decay categories above 5230 \mev is determined and fixed from the fit of data with the Cabibbo-favoured decay, taking into account the smaller branching fractions of the $D$ decays. It is less than an event for all the CP violating modes. Due to the assumptions present in the initial fit, uncertainties in the yield and shape and possible asymmetries in distribution between \Bp and \Bm are evaluated as systematic uncertainties. This systematic uncertainty is dealt with in Section \ref{sec:systematics:partreco}.


\clearpage

\section{Backgrounds}
\label{sec:backgrounds}

\subsection{Partially reconstructed $B \to D^*K^*$ decays}
\label{sec:backgrounds:partreco}

One of the major backgrounds in this analysis is from partially reconstructed \decay{\B}{\Dstar\Kstar} decays, discussed in detail in Section \ref{sec:massfit:partreco} and included in the mass fit.

\subsection{Charmless backgrounds $B \to K^*hh$}
\label{sec:backgrounds:charmless}

\B decays that do not proceed via a \D meson contribute to the charmless background. This is a peaking background under the signal region which is expected to be uniform in \D mass. The flight distance significance of the \Dz in the z direction is defined as,

\begin{equation}
\Dz\ FD\ significance = \frac{z_D - z_B}{\sqrt{\sigma_D^2 + \sigma_B^2}}
\label{FDdefinition}
\end{equation}

where, $\sigma_D$ and $\sigma_B$ are the errors in the z position of the \D and \B decay vertex respectively. This background is removed by requiring \Dz FD significance to exceed 2$\sigma$. The charmless background is estimated and removed by taking the D mass sidebands ($>$ 50 MeV from nominal \D mass) in data and performing a fit to the invariant \B mass distribution. In order to correctly estimate the background contribution in the \D sidebands all DTF variables are replaced in the selection as the use of these variables favours events towards the true \D mass. In the BDTs the DTF vertex $\chi^2$ fit is replaced with the non-DTF version. This fit to data is performed with a FD significance cut of both zero and 2$\sigma$, as shown in Figure \ref{charmlesspipi}. Corresponding plots for all the modes are given Appendix \ref{sec:app:charmless}.

\begin{figure}
\centering
\includegraphics[width=0.7\linewidth]{figures/backgrounds/charmlessFit_PiPi_DD_FD0.pdf}
\put(-100,100) {(a)}
\hfill
\includegraphics[width=0.7\linewidth]{figures/backgrounds/charmlessFit_PiPi_DD_FD2.pdf}
\put(-100,100) {(b)}
\caption{Fits to the Run 1 refitted B mass taking \decay{\Dz}{\pi\pi} candidates from the D mass sidebands after a FD significance cut (a) greater than 0 and (b) greater than 2$\sigma$. A Gaussian is used to model the signal and an exponential for the combinatoric background.}
\label{charmlesspipi}
\end{figure}

The yield of the \B mass peak is measured in the \D mass sidebands and then scaled to the \D mass window. This gives an estimate of the charmless yields expected after selection in the mass fit. These fits are performed using Run 1 data both with a FD significance cut of zero and a 2$\sigma$ FD cut applied, the resulting yields estimates are shown in Tables \ref{charmlessyieldsnofd} and \ref{charmlessyields} respectively. The same fits were peformed on Run 2 data and the results for the estimated charmless contribution in Run 2 for a zero and 2$\sigma$ FD cut, these are given in Tables \ref{charmlessyieldsnofdRun2} and \ref{charmlessyieldsRun2}.

\begin{table}[h] 
\centering 
\begin{tabular}{lll} 
\hline 
Mode & LL & DD \\ 
\hline 
$K\pi$ & $2.8 \pm 1.6$ & $2.6 \pm 1.9$ \\ 
$KK$ & $1.2 \pm 2.0$ & $0.6 \pm 2.2$ \\ 
$\pi\pi$ & $4.1 \pm 2.5$ & $16 \pm 4$ \\ 
$\pi K$ & $2.0 \pm 1.3$ & $0.0 \pm 0.6$ \\ 
$K\pi\pi\pi$ & $1.4 \pm 1.2$ & $1.5 \pm 2.0$ \\ 
$\pi\pi\pi\pi$ & $2.2 \pm 2.4$ & $6.8 \pm 3.5$ \\ 
$\pi K \pi\pi$ & $1.1 \pm 0.9$ & $1.3 \pm 1.2$ \\ 
\hline 
\end{tabular}
\caption{Estimated charmless contribution in Run 1 data for each of the D decay modes with a FD significance cut of zero applied} 
\label{charmlessyieldsnofd} 
\end{table}

\begin{table}[h]
\centering
\begin{tabular}{lll} 
\hline 
Mode & LL & DD \\ 
\hline 
$K\pi$ & $1.7 \pm 1.0$ & $0.2 \pm 1.6$ \\ 
$KK$ & $0.0 \pm 0.4$ & $0.0 \pm 0.4$ \\ 
$\pi\pi$ & $1.2 \pm 1.5$ & $2.0 \pm 1.6$ \\ 
$\pi K$ & $1.0 \pm 0.9$ & $0.0 \pm 0.3$ \\ 
$K\pi\pi\pi$ & $1.3 \pm 1.1$ & $0.1 \pm 3.7$ \\ 
$\pi\pi\pi\pi$ & $0.0 \pm 7.4$ & $0.0 \pm 1.2$ \\ 
$\pi K \pi\pi$ & $0.9 \pm 0.7$ & $0.0 \pm 0.7$ \\ 
\hline 
\end{tabular}
\caption{Estimated charmless contribution in Run 1 data for each of the D decay modes with a FD significance cut of 2$\sigma$ applied}
\label{charmlessyields}
\end{table}

\begin{table}[h] 
\centering 
\begin{tabular}{lll} 
\hline 
Mode & LL & DD \\ 
\hline 
$K\pi$ & $0.0 \pm 0.4$ & $0.0 \pm 1.6$ \\ 
$KK$ & $5.2 \pm 2.6$ & $7.1 \pm 4.0$ \\ 
$\pi\pi$ & $11 \pm 4$ & $30 \pm 5$ \\ 
$\pi K$ & $0.2 \pm 2.8$ & $1.1 \pm 1.7$ \\ 
$K\pi\pi\pi$ & $0.3 \pm 2.7$ & $1.6 \pm 3.3$ \\ 
$\pi\pi\pi\pi$ & $7.0 \pm 3.4$ & $8.7 \pm 5.3$ \\ 
$\pi K \pi\pi$ & $0.0 \pm 2.3$ & $0 \pm 17$ \\ 
\hline 
\end{tabular} 
\caption{Estimated charmless contribution in Run 2 data for each of the D decay modes with a FD significance cut of zero applied} 
\label{charmlessyieldsnofdRun2} 
\end{table}

\begin{table}[h] 
\centering 
\begin{tabular}{lll} 
\hline 
Mode & LL & DD \\ 
\hline 
$K\pi$ & $0.0 \pm 0.3$ & $0.6 \pm 1.3$ \\ 
$KK$ & $0.0 \pm 0.3$ & $0.0 \pm 0.7$ \\ 
$\pi\pi$ & $0.0 \pm 1.2$ & $2.3 \pm 2.2$ \\ 
$\pi K$ & $0.4 \pm 1.0$ & $0.0 \pm 0.5$ \\ 
$K\pi\pi\pi$ & $1.0 \pm 1.4$ & $0.0 \pm 7.6$ \\ 
$\pi\pi\pi\pi$ & $1.4 \pm 2.3$ & $0.0 \pm 1.0$ \\ 
$\pi K \pi\pi$ & $0.0 \pm 10.6$ & $1.4 \pm 1.5$ \\ 
\hline 
\end{tabular} 
\caption{Estimated charmless contribution in Run 2 data for each of the D decay modes with a FD significance cut of 2$\sigma$ applied} 
\label{charmlessyieldsRun2}
\end{table}

The \Dz FD significance is required to exceed 2$\sigma$, therefore from Tables \ref{charmlessyields} and \ref{charmlessyieldsRun2} it can be seen that all charmless contributions are consistent with zero. The expected yields in the $K\pi$ favoured and $KK$ modes are significantly less than 1\% of the expected signal yield. However, the charmless contribution in the $\pi\pi$ mode could be significant. A systematic is assigned to the possible charmless contribution in the $\pi\pi$ mode, details are given in Section \ref{sec:systematics}. 

\subsection{\decay{\B}{\D\pi\pi\pi}}
\label{sec:backgrounds:b2dpipipi}

\decay{\B}{\D\pi\pi\pi} decays, with a branching fraction of $5.7 \times 10^{-3}$~\cite{PDG2014} (about 50 times the signal branching fraction), are expected to occur as a peaking background underneath the signal. In order to remove this background, events are selected with the requirement that the \KS has flown. For DD candidates this requirement is already satisfied, however for LL candidates the flight distance significance of the \KS in the z direction, with the equivalent definition as for \Dz given in Equation \ref{FDdefinition}, is required to exceed 5$\sigma$. 

The \decay{\B}{\D\pi\pi\pi} background is removed by taking the \KS mass sidebands ($>$ 20 MeV from nominal \KS mass) in data and performing a fit to the invariant \B mass distribution. All DTF variables are replaced in the selection as descibed in Section \ref{sec:backgrounds:charmless}. This fit to data is performed for the favoured \decay{\Dz}{\Km\pip} mode with a FD significance cut of both zero and 5$\sigma$, as shown in Figure \ref{strangelessfits}. It can be seen that the 5$\sigma$ FD significance selection removes all of the \decay{\B}{\D\pi\pi\pi} background.

\begin{figure}
\centering
\includegraphics[width=0.7\linewidth]{figures/backgrounds/B2DpipipiFit_KPi_LL_FD0_run2.pdf}
\put(-100,100) {(a)}
\hfill
\includegraphics[width=0.7\linewidth]{figures/backgrounds/B2DpipipiFit_KPi_LL_FD5_run2.pdf}
\put(-100,100) {(b)}
\caption{Fits to the Run 2 refitted B mass taking \decay{\Dz}{\Km\pip} candidates from the \KS mass sidebands after a FD significance cut (a) greater than 0 and (b) greater than 5$\sigma$. Expected  \decay{\B}{\D\pi\pi\pi} yield in the signal region with FD significance $>$ 0 is $77 \pm 11$ and signal yield with FD significance $>$ 5 is $1.0 \pm 1.0$. A Gaussian is used to model the signal and an exponential for the combinatoric background}
\label{strangelessfits}
\end{figure}

\subsection{Non-resonant $B \to DK_s\pi$}
\label{sec:backgrounds:non-resonant}

Non-resonant background is reduced by removing events in which the \KS\pion invariant mass is greater than 75 MeV from the nominal \Kstarpm mass. \decay{\Bpm}{\D\Kstarpm} is a Scalar $\to$ Scalar Vector decay, which means the \Kstarpm must be londitudially polarised, so the $K_s$ helicity angle of pure \D\Kstarpm events follows a $\cos^2\theta$ distribution, as shown in Figure \ref{helicitycut}, compared to the uniform distribution of non-resonant components. It can be seen from Figure \ref{helicitycut} that the \KS helicity angle distribution is not symmetric, this is discussed in detail in Appendix \ref{sec:app:helicityangle}. Removing events with an absolute value of $\cos^2\theta$ less than 0.3 improves the purity of \D\Kstarpm decays compared to non-resonant background.

\begin{figure}[h]
\includegraphics[width=\linewidth]{figures/backgrounds/KsHelicityCut.pdf}
\put(-400,100) {(a)}
\put(-170,100) {(b)}
\caption{MC distribution of the cosine of Ks helicity angle for (a) LL candidates and (b) DD candidates}
\label{helicitycut}
\end{figure}

It is necessary to estimate the fraction of non-resonant \decay{\B}{\D\KS\pi} in the signal candidates. Figure \ref{kshelicitycomparison} shows a comparison of \KS helicity angle and the \KS momentum between signal MC and sWeighted data. There is a discrepancy in both \KS helicity angle distribution and the \KS momentum distribution. The discrepancy in the momentum distribution was corrrected by reweighting the MC, the resulting helicity angle distribution is consistent with the data, as shown in Figure \ref{kshelicitycomparisonreweighted}.

\begin{figure}[h]
\includegraphics[width=0.5\linewidth]{figures/backgrounds/KsHelicityAngle_sweighted.pdf}
\put(-170,100) {(a)}
\includegraphics[width=0.5\linewidth]{figures/backgrounds/KsP_sweighted.pdf}
\put(-170,100) {(b)}
\caption{Comparison of (a) cosine of the helicity angle distribution and (b) the \KS momentum distribution in sWeighted data (red) and MC (blue)}
\label{kshelicitycomparison}
\end{figure}

\begin{figure}[h]
\centering
\includegraphics[width=0.6\linewidth]{figures/backgrounds/KsHelicityAngle_sweighted_MCweighted.pdf}
\caption{Comparison of cosine of the helicity angle distribution in sWeighted data (red) and MC (blue) reweighted to give the same \KS momentum distribution}
\label{kshelicitycomparisonreweighted}
\end{figure}

The parameter $\kappa$, defined in Section \ref{sec:interpretation:coherence}, is a measure of the non-$DK(892)^*$ contribution, which is expected to mainly consist of non-resonant contribution, but could include other resonances. In this analysis the value of $\kappa$ is estimated and then used alongside the \CP observables to extract \Pgamma, $r_B$ and $\delta_B$. The parameter $\kappa$ is estimated by constructing an amplitude model and generating many toys by varying the amplitudes and phases of the model components, this method is detailed in Section \ref{sec:interpretation:coherence}. The estimated value of $\kappa$ is $0.95 \pm 0.06$.

\subsection{Favoured $\to$ Supressed crossfeed}
\label{sec:backgrounds:crossfeed}

The doubly Cabibo supressed ADS mode, \decay{\Bm}{\D(\Kp\pim)\Kstarm}, can have contamination coming from the favoured \decay{\Bm}{\D(\Km\pip)\Kstarm} mode, where the daughter mass hypotheses are swapped, i.e. the kaon is misidentified as a pion and the pion is misidentified as a kaon. The favoured mode has a braching ratio 281 times higher than the ADS mode. Implementation of PID cuts of the \D daughters significantly reduces this background, however in order to reduce it to negligible levels a veto is applied. The \Dz mass is reconstructed where both daughter mass hypotheses are swapped, this is required to be greater than 15 MeV away from the nominal \Dz mass. This veto window is illustrated in Figure \ref{Dmassveto}, which shows the MC distributions for DD canidates in Run 1. The veto is only applied to the ADS mode in this analysis. It is found to be 92.5\% efficient at retaining genuine signal, corresponding to events that lie within the red lines in Figure \ref{Dmassveto} (a), while only retaining 8.7\% of double misID background, coresponding to events that lie within the red lines in Figure \ref{Dmassveto} (b). For the 4-body modes the same background can appear in the suppressed \decay{\Bm}{\D(\Kp\pim\pip\pim)\Kstarm} mode due to contamination from the favoured \decay{\Bm}{\D(\Km\pip\pim\pip)\Kstarm}. There are two \pip mesons that could be misidetified as a \Kp meson, therefore in this case two vetos need to be applied. The \Dz mass is reconstructed as a swapped mass hypothesis where the kaon is swapped with the lower momentum pion and the kaon is swapped with the higher momentum pion. The veto is applied to both these reconstructed masses as shown in Figure \ref{Dmassveto4body}.

\begin{figure}[h]
\includegraphics[width=\linewidth]{figures/backgrounds/Dmassveto.pdf}
\put(-410,150) {(a)}
\put(-180,150) {(b)}
\caption{MC distributions for DD canidates in Run 1 showing D mass with (a) the correct D daughter mass hypothesis and (b) the swapped D daughter mass hypothesis. The red lines correcpond to the double misID veto selection window applied to the ADS mode}
\label{Dmassveto}
\end{figure}

\begin{figure}[h]
\includegraphics[width=\linewidth]{figures/backgrounds/Dmassveto_4body.pdf}
\put(-410,150) {(a)}
\put(-180,150) {(b)}
\caption{MC distributions for DD canidates in Run 2 showing the swapped D daughter mass hypothesis where (a) the kaon is swapped with the lower momentum pion and (b) the kaon is swapped with the higher momentum pion. The red lines correspond to the double misID veto selection window applied to the suppressed mode}
\label{Dmassveto4body}
\end{figure}

In order to determine the overall crossfeed contamination in the supressed mode the efficiency of the D mass window, double misID veto and PID requirements are taken into account for both the normal and swapped \Dz mass hypothesis. For the 2-body mode, these efficiencies are listed in Tables \ref{crossfeedefficienciesRun1} and \ref{crossfeedefficienciesRun2}. The proportion of events that will enter the supressed mode fit relative to the total \decay{\Bm}{\D(\Kp\pim)\Kstarm} is estimated to be $9.5 \times 10^{-3}$ for LL and $6.5 \times 10^{-3}$ for DD in Run 1, and $5.6 \times 10^{-3}$ for LL and $5.3 \times 10^{-3}$ in Run 2. Similarly for the 4-body mode, the efficiencies are listed in Tables \ref{crossfeedefficienciesk3piRun1} and \ref{crossfeedefficienciesk3piRun2}. The proportion of events that will enter the supressed mode fit relative to the total \decay{\Bm}{\D(\Kp\pim\pip\pim)\Kstarm} is estimated to be $2.7 \times 10^{-3}$ for LL and $1.0 \times 10^{-3}$ for DD in Run 1, and $1.4 \times 10^{-3}$ for LL and $6.3 \times 10^{-4}$ in Run 2. Therefore, the contribtuion of the crossfeed in the supressed mode is negligible.

%The tighter BDT cut applied in the ADS mode for DD candidates also has to be taken into account. The relative BDT efficiency is 0.877 for Run 1 and 0.902 for Run 2.

\begin{table}[h]
\centering
\begin{tabular}{ccc}
\hline
Selection cut & $[K_K^-\pi_\pi^+]_D$ efficiency & $[K_\pi^-\pi_K^+]_D$ efficiency \\
\hline
\Dz window: $\pm$ 25 MeV & 0.961 $\pm$ 0.003 & 0.116 $\pm$ 0.005 \\
Crossfeed veto $\pm$ 15 MeV & 0.930 $\pm$ 0.004 & 0.122 $\pm$ 0.014 \\
PID selection & 0.734 $\pm$ 0.002 & 0.00158 $\pm$ 0.00002 \\
\hline
Total & 0.655 $\pm$ 0.004 & (2.2 $\pm$ 0.3) $\times 10^{-5}$ \\
\hline
\end{tabular}
\begin{tabular}{ccc}
\hline
Selection cut & $[K_K^-\pi_\pi^+]_D$ efficiency & $[K_\pi^-\pi_K^+]_D$ efficiency \\
\hline
\Dz window: $\pm$ 25 MeV & 0.961 $\pm$ 0.002 & 0.123 $\pm$ 0.003 \\
Crossfeed veto $\pm$ 15 MeV & 0.925 $\pm$ 0.002 & 0.087 $\pm$ 0.007 \\
PID selection & 0.747 $\pm$ 0.002 & 0.00144 $\pm$ 0.00005 \\
\hline
Total & 0.663 $\pm$ 0.003 & (1.53 $\pm$ 0.14) $\times 10^{-5}$ \\
\hline
\end{tabular}
\caption{Efficiencies of the \Dz mass window, crossfeed veto and \Dz daughter PID cuts for \decay{\Bpm}{[\Kmp\pipm]_D\Kstarpm} events in Run 1. The first table shows the LL efficiencies and the second shows the DD efficiencies. The proprtion of crossfeed events from favoured \decay{\Bpm}{[\Kpm\pimp]_D\Kstarpm} mode which are expected in \decay{\Bpm}{[\Kmp\pipm]_D\Kstarpm} mode fit is $(9.5 \pm 1.2) \times 10^{-3}$ for LL and $(6.5 \pm 0.6) \times 10^{-3}$ for DD}
\label{crossfeedefficienciesRun1}
\end{table}

\begin{table}
\centering
\begin{tabular}{ccc}
\hline
Selection cut & $[K_K^-\pi_\pi^+]_D$ efficiency & $[K_\pi^-\pi_K^+]_D$ efficiency \\
\hline
\Dz window: $\pm$ 25 MeV & 0.954 $\pm$ 0.002 & 0.118 $\pm$ 0.003 \\
Crossfeed veto $\pm$ 15 MeV & 0.929 $\pm$ 0.003 & 0.108 $\pm$ 0.009 \\
PID selection & 0.811 $\pm$ 0.002 & 0.00112 $\pm$ 0.00002 \\
\hline
Total & 0.719 $\pm$ 0.003 & (1.43 $\pm$ 0.12) $\times 10^{-5}$ \\
\hline
\end{tabular}
\begin{tabular}{ccc}
\hline
Selection cut & $[K_K^-\pi_\pi^+]_D$ efficiency & $[K_\pi^-\pi_K^+]_D$ efficiency \\
\hline
\Dz window: $\pm$ 25 MeV & 0.9553 $\pm$ 0.0012 & 0.1181 $\pm$ 0.0019 \\
Crossfeed veto $\pm$ 15 MeV & 0.9284 $\pm$ 0.0016 & 0.111 $\pm$ 0.005 \\
PID selection & 0.821 $\pm$ 0.002 & 0.00104 $\pm$ 0.00002 \\
\hline
Total & 0.728 $\pm$ 0.002 & (1.37 $\pm$ 0.08) $\times 10^{-5}$ \\
\hline
\end{tabular}
\caption{Efficiencies of the \Dz mass window, crossfeed veto and \Dz daughter PID cuts for \decay{\Bpm}{[\Kmp\pipm]_D\Kstarpm} events in Run 2. The first table shows the LL efficiencies and the second shows the DD efficiencies. The proprtion of crossfeed events from favoured \decay{\Bpm}{[\Kpm\pimp]_D\Kstarpm} mode which are expected in \decay{\Bpm}{[\Kmp\pipm]_D\Kstarpm} mode fit is $(5.6 \pm 0.5) \times 10^{-3}$ for LL and $(5.3 \pm 0.3) \times 10^{-3}$ for DD}
\label{crossfeedefficienciesRun2}
\end{table}

\begin{table}[h]
\centering
\begin{tabular}{ccc}
\hline
Selection cut & $[K_K^-\pi_\pi^+\pim\pip]_D$ efficiency & $[K_\pi^-\pi_K^+\pim\pip]_D$ efficiency \\
\hline
\Dz window: $\pm$ 25 MeV & 0.749 $\pm$ 0.011 & 0.009 $\pm$ 0.002 \\
Crossfeed veto $\pm$ 15 MeV & 0.907 $\pm$ 0.008 & 0.50 $\pm$ 0.13 \\
PID selection & 0.630 $\pm$ 0.002 & 0.00089 $\pm$ 0.00002 \\
\hline
Total & 0.428 $\pm$ 0.007 & (3.8 $\pm$ 1.4) $\times 10^{-6}$ \\
\hline
\end{tabular}
\begin{tabular}{ccc}
\hline
Selection cut & $[K_K^-\pi_\pi^+\pim\pip]_D$ efficiency & $[K_\pi^-\pi_K^+\pim\pip]_D$ efficiency \\
\hline
\Dz window: $\pm$ 25 MeV & 0.817 $\pm$ 0.006 & 0.0080 $\pm$ 0.0013 \\
Crossfeed veto $\pm$ 15 MeV & 0.904 $\pm$ 0.005 & 0.23 $\pm$ 0.07 \\
PID selection & 0.636 $\pm$ 0.002 & 0.00084 $\pm$ 0.00002 \\
\hline
Total & 0.470 $\pm$ 0.004 & (1.54 $\pm$ 0.5) $\times 10^{-6}$ \\
\hline
\end{tabular}
\caption{Efficiencies of the \Dz mass window, crossfeed veto and \Dz daughter PID cuts for \decay{\Bpm}{[\Kmp\pipm\pimp\pipm]_D\Kstarpm} events in Run 1. The first table shows the LL efficiencies and the second shows the DD efficiencies. The proprtion of crossfeed events from favoured \decay{\Bpm}{[\Kpm\pimp\pipm\pimp]_D\Kstarpm} mode which are expected in \decay{\Bpm}{[\Kmp\pipm\pimp\pipm]_D\Kstarpm} mode fit is $(2.7 \pm 1.0) \times 10^{-3}$ for LL and $(1.0 \pm 0.4) \times 10^{-3}$ for DD}
\label{crossfeedefficienciesk3piRun1}
\end{table}

\begin{table}
\centering
\begin{tabular}{ccc}
\hline
Selection cut & $[K_K^-\pi_\pi^+\pim\pip]_D$ efficiency & $[K_\pi^-\pi_K^+\pim\pip]_D$ efficiency \\
\hline
\Dz window: $\pm$ 25 MeV & 0.791 $\pm$ 0.003 & 0.0072 $\pm$ 0.0007 \\
Crossfeed veto $\pm$ 15 MeV & 0.905 $\pm$ 0.003 & 0.31 $\pm$ 0.05 \\
PID selection & 0.784 $\pm$ 0.002 & 0.00115 $\pm$ 0.00002 \\
\hline
Total & 0.561 $\pm$ 0.003 & (2.6 $\pm$ 0.5) $\times 10^{-6}$ \\
\hline
\end{tabular}
\begin{tabular}{ccc}
\hline
Selection cut & $[K_K^-\pi_\pi^+\pim\pip]_D$ efficiency & $[K_\pi^-\pi_K^+\pim\pip]_D$ efficiency \\
\hline
\Dz window: $\pm$ 25 MeV & 0.820 $\pm$ 0.002 & 0.0057 $\pm$ 0.0004 \\
Crossfeed veto $\pm$ 15 MeV & 0.9040 $\pm$ 0.0018 & 0.20 $\pm$ 0.03\\
PID selection & 0.798 $\pm$ 0.002 & 0.00106 $\pm$ 0.00002 \\
\hline
Total & 0.592 $\pm$ 0.002 & (1.2 $\pm$ 0.2) $\times 10^{-6}$ \\
\hline
\end{tabular}
\caption{Efficiencies of the \Dz mass window, crossfeed veto and \Dz daughter PID cuts for \decay{\Bpm}{[\Kmp\pipm\pimp\pipm]_D\Kstarpm} events in Run 2. The first table shows the LL efficiencies and the second shows the DD efficiencies. The proprtion of crossfeed events from favoured \decay{\Bpm}{[\Kpm\pimp\pipm\pimp]_D\Kstarpm} mode which are expected in \decay{\Bpm}{[\Kmp\pipm\pimp\pipm]_D\Kstarpm} mode fit is $(1.4 \pm 0.3) \times 10^{-3}$ for LL and $(6.3 \pm 1.1) \times 10^{-4}$ for DD}
\label{crossfeedefficienciesk3piRun2}
\end{table}

\clearpage

\subsection{Lambda contamination}
\label{sec:backgrounds:contamination}

The \decay{\KS}{\pip\pim} decay could have contamination coming from \decay{\Lz}{\proton\pim}, where the proton is reconstructed as a pion. It is not possible to determine possible \Lz contamination from the \KS invariant mass spectrum, where one of the \KS daughters is assigned the proton mass, because a peak at the \Lz mass cannot be distinguished from the variation near the low mass threshold. In order to distinguish between \KS decays and \Lz contamination the Armenteros-Podolanski (AP) plot is used~\cite{APplot}. The transverse momentum of the daughters with respect to the mother particle, $p_T$, is plotted against the longitudinal momentum asymmetry, which is defined as,

\begin{equation}
\frac{p_L^+ - p_L^-}{p_L^+ + p_L^-}
\end{equation}

where $p_L^{\pm}$ is the longitudinal momentum of the daughter particles with respect to the direction of the mother. The resulting AP plots for both data and MC are shown in Figure \ref{applots}. Both the data and MC samples have passed the full selection, except the MC sample does not have any PID applied. The decay products of the \decay{\KS}{\pip\pim} decay have the same mass and therefore on average their momenta is symmetrically distributed, resulting in the distribution observed in Figure \ref{applots}; these curves are the same shape as the expected distribution for a sample of pure \KS mesons. The distribution of the events in the data sample can be seen more clearly in Figure \ref{applotsdata}. Whereas for the \decay{\Lz}{\proton\pim}, the proton would, on average, take a larger proportion of the momentum resulting in an asymmteric distribution. Contamination from \Lz baryons would be clearly seen as a distinct structure on the AP plot, as illustrated in Figure \ref{apexample}. Therefore, Figure \ref{applots} shows that there is no contamination from \decay{\Lz}{\proton\pim} decays in this sample.

\begin{figure}[h]
\includegraphics[width=0.5\linewidth]{figures/backgrounds/APplot_LL.pdf}
\put(-190,120) {(a)}
\hfill
\includegraphics[width=0.5\linewidth]{figures/backgrounds/APplot_DD.pdf}
\put(-190,120) {(b)}
\caption{Armenteros-Podolanski plots for (a) LL, and (b) DD canididates. The $p_T$ values on the y axis are the transverse momentum of the daughters with respect to the mother particle and the x axis contains the longitudinal momentum asymmetry. The black points represent data and the red points represent MC.}
\label{applotsdata}
\end{figure}

\begin{figure}
\includegraphics[width=0.5\linewidth]{figures/backgrounds/APplot_dataLL.pdf}
\put(-190,120) {(a)}
\hfill
\includegraphics[width=0.5\linewidth]{figures/backgrounds/APplot_dataDD.pdf}
\put(-190,120) {(b)}
\caption{Armenteros-Podolanski plots for (a) LL, and (b) DD canididates in data. The $p_T$ values on the y axis are the transverse momentum of the daughters with respect to the mother particle and the x axis contains the longitudinal momentum asymmetry. The black points represent data and the red points represent MC.}
\label{applots}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=0.5\linewidth]{figures/backgrounds/APfromPaper2.pdf}
\caption{An example Armenteros-Podolanski plot showing where the signal regions for \KS, \Lz and \Lbar are located in the AP plane~\cite{APplot}}
\label{apexample}
\end{figure}

\subsection{\decay{\B}{\D\KS\kaon}}
\label{sec:backgrounds:b2dkks}

The decay \decay{\B}{\D\KS\kaon} has a branching fraction of $5.5 \times 10^{-4}$~\cite{PDG2014}, which is similar to the signal branching fraction. However, nearly all of this background is removed by the 75 MeV \Kstarpm mass window and the DLLK $<$ 4 requirement on the bachelor pion. Table \ref{b2dkkspid} shows the rate of misidentification of the bachelor pion for \decay{\B}{\D\KS\kaon} MC.

\begin{table}[h]
\centering
\begin{tabular}{c|cc|cc}
\hline
& \multicolumn{2}{c}{LL} & \multicolumn{2}{c}{DD} \\
& MagUp & MagDown & MagUp & MagDown \\
\hline
2012 & $8.9 \pm 0.2$ & $8.1 \pm 0.2$ & $8.3 \pm 0.2$ & $8.0 \pm 0.2$ \\
2015 & $8.5 \pm 0.2$ & $9.7 \pm 0.2$ & $7.8 \pm 0.2$ & $7.4 \pm 0.2$ \\
\hline
Average Run 1 & \multicolumn{2}{c}{$8.5 \pm 0.3$} & \multicolumn{2}{c}{$8.2 \pm 0.3$} \\
Average Run 2 & \multicolumn{2}{c}{$9.1 \pm 0.2$} & \multicolumn{2}{c}{$7.6 \pm 0.3$} \\
\hline
\end{tabular}
\caption{MisID efficiencies for $B \to DK_sK$. The values in the table are given as percentages.}
\label{b2dkkspid}
\end{table}

Table \ref{b2dkkspid} shows that by requiring DLLK $<$ 4 on the bachelor pion the background is supressed to about 8\%. The efficiency of the 75 MeV \Kstarpm mass window when applied to \decay{\B}{\D\KS\kaon} MC is 3\% for both LL and DD. Combined misID rate and selection efficiencies means the decay is negligible even if the PID performance in Run 2 is not identical. Any residual amount is investigated alongside the systematics for the residual low mass background in this region.


\subsection{Other backgrounds}

Other backgrounds have been looked into and shown to have negligible contribution; a summary of these is given in Table \ref{ignoredbackgrounds}. No branching ratio has been measured for \decay{\Bm}{\Dz\Kstarm\piz} and \decay{\Bs}{\Dz\KS\pi\pi}, upper limits are guestimated hence this gives further motivation for restricting the mass range to 5230 \mevcc. As these backgrounds are estimated to have a low contribution in an area outside the mass range chosen for the \CP fit, they are considered negligible.

\begin{table}[h]
\centering
\begin{tabular}{cccc}
\hline
Decay mode & BR & Events relative to signal yield & Mass range (MeV) \\
\hline
\decay{\Bm}{\Dz\Kstarm\piz} & $6 \times 10^{-4}$ & 0.037/0.049 & 4750-5150 \\
\decay{\Bs}{\Dz\KS\pi\pi} & $5 \times 10^{-4}$ & 0.004/0.003 & 4750-5120 \\
\hline
\end{tabular}
\caption{Summary of background that have been investigated and determined to be negligible. Relative number of events are given for LL and DD (LL/DD). Branching ratios are guestimated upper limits}
\label{ignoredbackgrounds}
\end{table}

%In the \decay{\B}{Dh} analysis~\cite{LHCb-PAPER-2016-003}, the background \decay{\Lb}{\Lcm(\proton\Kp[\pim])\Kp} enters into the \decay{\Dz}{\Kp\Km} mode. This is where the \pim is missed in the reconstruction and the \proton is misIDed as a \kaon, this results in the recontructed \B mass falling within the mass fit range. This was found to be negligible and not affect the 

Many other backgrounds have been looked into and have been found to be negligible:

\begin{itemize}
\item \decay{\Bs}{\Dzb\Kstarz(\Kstarp[\pim])}
\item \decay{\Bs}{\Dstarp\Kstarp}
\item \decay{\Bs}{\Dspm(\kaon\kaon\pi)\Kstarpm}
\item \decay{\Bu}{\D\pi} with a random \KS added
\item \decay{\Bd}{\D\KS} with a  random pion added
\item \decay{\Bs}{\D\KS} with a random pion added
\item \decay{\Bu}{\D(\KS\pi\pi)\Kp}
\item \decay{\Lb}{\Lambda_c^-(\proton\Kp[\pim])\Kstarp} with the \proton misIDed as a kaon
\end{itemize}

\clearpage
